<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>易趣SafePay - 智能USDT担保交易平台</title>
<style>
  :root{
    --bg-dark:#0a0e1a;
    --bg-card:#131825;
    --bg-hover:#1a2235;
    --border:#2a3245;
    --text-primary:#ffffff;
    --text-secondary:#94a3b8;
    --text-muted:#64748b;
    --primary:#3b82f6;
    --primary-dark:#2563eb;
    --success:#10b981;
    --warning:#f59e0b;
    --danger:#ef4444;
    --info:#06b6d4;
  }
  
  *{margin:0;padding:0;box-sizing:border-box}
  
  body{
    background:var(--bg-dark);
    background-image:radial-gradient(circle at 20% 80%, #1e40af15 0%, transparent 50%),
                     radial-gradient(circle at 80% 20%, #7c3aed15 0%, transparent 50%),
                     radial-gradient(circle at 40% 40%, #10b98115 0%, transparent 50%);
    font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
    color:var(--text-primary);
    min-height:100vh;
  }
  
  .container{
    max-width:1280px;
    margin:0 auto;
    padding:24px;
  }
  
  .navbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:20px 0;
    margin-bottom:32px;
    border-bottom:1px solid var(--border);
  }
  
  .logo{
    display:flex;
    align-items:center;
    gap:12px;
    font-size:24px;
    font-weight:700;
  }
  
  .logo-icon{
    width:40px;
    height:40px;
    background:linear-gradient(135deg, var(--primary), var(--info));
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  
  .nav-right{
    display:flex;
    align-items:center;
    gap:24px;
  }
  
  .user-info{
    display:flex;
    align-items:center;
    gap:12px;
    padding:8px 16px;
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:12px;
  }
  
  .reputation-score{
    display:flex;
    align-items:center;
    gap:4px;
    padding:4px 8px;
    background:rgba(16,185,129,0.1);
    border-radius:6px;
    font-size:13px;
    color:var(--success);
  }
  
  .kyc-badge{
    padding:4px 8px;
    background:rgba(59,130,246,0.1);
    border:1px solid rgba(59,130,246,0.3);
    border-radius:6px;
    font-size:11px;
    color:var(--primary);
    font-weight:600;
  }
  
  .user-address-display{
    font-family:monospace;
    font-size:14px;
    color:var(--primary);
  }
  
  .login-card{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:32px;
    margin-bottom:32px;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);
  }
  
  .login-card-header{
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:24px;
  }
  
  .login-card-icon{
    width:56px;
    height:56px;
    background:linear-gradient(135deg, var(--primary), var(--info));
    border-radius:14px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;
  }
  
  .login-card-title{
    flex:1;
  }
  
  .login-card-title h2{
    font-size:22px;
    font-weight:700;
    margin-bottom:4px;
  }
  
  .login-card-subtitle{
    font-size:14px;
    color:var(--text-secondary);
  }
  
  .login-status-badge{
    padding:8px 16px;
    background:rgba(16,185,129,0.1);
    border:1px solid rgba(16,185,129,0.3);
    border-radius:10px;
    color:var(--success);
    font-weight:600;
    font-size:14px;
    display:none;
  }
  
  .login-status-badge.show{
    display:block;
  }
  
  .login-form-container{
    display:flex;
    gap:16px;
    align-items:center;
  }
  
  .login-input-wrapper{
    flex:1;
    position:relative;
  }
  
  .login-input-field{
    width:100%;
    padding:14px 16px 14px 48px;
    background:var(--bg-hover);
    border:2px solid var(--border);
    border-radius:12px;
    color:var(--text-primary);
    font-size:15px;
    font-family:monospace;
    transition:all 0.3s;
  }
  
  .login-input-icon{
    position:absolute;
    left:16px;
    top:50%;
    transform:translateY(-50%);
    color:var(--text-muted);
    font-size:18px;
  }
  
  .login-input-field:focus{
    outline:none;
    border-color:var(--primary);
    background:rgba(59,130,246,0.05);
  }
  
  .login-input-field:disabled{
    background:rgba(16,185,129,0.05);
    border-color:rgba(16,185,129,0.3);
    color:var(--success);
    cursor:not-allowed;
  }
  
  .login-buttons{
    display:flex;
    gap:12px;
  }
  
  .login-btn{
    padding:14px 28px;
    border:none;
    border-radius:12px;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s;
    display:inline-flex;
    align-items:center;
    gap:8px;
    white-space:nowrap;
  }
  
  .login-btn.primary{
    background:linear-gradient(135deg, var(--primary), var(--primary-dark));
    color:white;
  }
  
  .login-btn.primary:hover:not(:disabled){
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(59,130,246,0.3);
  }
  
  .login-btn.secondary{
    background:linear-gradient(135deg, var(--warning), #dc2626);
    color:white;
  }
  
  .login-btn.secondary:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(245,158,11,0.3);
  }
  
  .login-btn:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }
  
  .login-tips{
    margin-top:20px;
    padding:16px;
    background:rgba(59,130,246,0.05);
    border:1px solid rgba(59,130,246,0.2);
    border-radius:12px;
    font-size:13px;
    line-height:1.8;
    color:var(--text-secondary);
  }
  
  .main-grid{
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:24px;
  }
  
  .card{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:28px;
  }
  
  .card-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
  }
  
  .card-title{
    font-size:20px;
    font-weight:600;
  }
  
  .role-selector{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-bottom:24px;
  }
  
  .role-option{
    padding:16px;
    background:var(--bg-hover);
    border:2px solid var(--border);
    border-radius:12px;
    cursor:pointer;
    transition:all 0.3s;
    text-align:center;
  }
  
  .role-option:hover{
    border-color:var(--primary);
    background:rgba(59,130,246,0.05);
  }
  
  .role-option.selected{
    border-color:var(--primary);
    background:rgba(59,130,246,0.1);
  }
  
  .role-icon{
    font-size:28px;
    margin-bottom:8px;
  }
  
  .role-name{
    font-weight:600;
    margin-bottom:4px;
  }
  
  .role-desc{
    font-size:12px;
    color:var(--text-muted);
  }
  
  .form-group{
    margin-bottom:20px;
  }
  
  .form-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:16px;
  }
  
  label{
    display:block;
    font-size:13px;
    color:var(--text-secondary);
    margin-bottom:8px;
    font-weight:500;
  }
  
  .required{
    color:var(--danger);
  }
  
  input, textarea{
    width:100%;
    padding:12px 14px;
    background:var(--bg-hover);
    border:1px solid var(--border);
    border-radius:10px;
    color:var(--text-primary);
    font-size:14px;
    transition:all 0.3s;
  }
  
  input:focus, textarea:focus{
    outline:none;
    border-color:var(--primary);
    background:rgba(59,130,246,0.05);
  }
  
  /* ★★★ 修复下拉选项框样式 ★★★ */
  select{
    width:100%;
    padding:12px 40px 12px 14px;
    background-color:var(--bg-hover);
    border:1px solid var(--border);
    border-radius:10px;
    color:var(--text-primary);
    font-size:14px;
    transition:all 0.3s;
    cursor:pointer;
    -webkit-appearance:none;
    -moz-appearance:none;
    appearance:none;
    background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat:no-repeat;
    background-position:right 12px center;
    background-size:20px;
  }
  
  select:focus{
    outline:none;
    border-color:var(--primary);
    background-color:rgba(59,130,246,0.05);
  }
  
  select option{
    background-color:var(--bg-card);
    color:var(--text-primary);
    padding:8px;
    font-size:14px;
  }
  
  select option:hover{
    background-color:var(--bg-hover);
  }
  
  select option:checked{
    background:linear-gradient(to right, var(--primary), var(--primary));
    color:white;
  }
  
  /* Firefox 专门修复 */
  @-moz-document url-prefix(){
    select{
      background-color:var(--bg-hover) !important;
      color:var(--text-primary) !important;
    }
    select option{
      background-color:var(--bg-card) !important;
      color:var(--text-primary) !important;
    }
  }
  
  /* Webkit内核浏览器修复 */
  @media screen and (-webkit-min-device-pixel-ratio:0){
    select option{
      background-color:#131825 !important;
      color:#ffffff !important;
    }
  }
  
  textarea{
    min-height:100px;
    resize:vertical;
  }
  
  .risk-assessment{
    background:var(--bg-hover);
    border-radius:12px;
    padding:16px;
    margin-bottom:20px;
  }
  
  .risk-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
  }
  
  .risk-title{
    font-size:14px;
    font-weight:600;
  }
  
  .risk-score{
    display:flex;
    align-items:center;
    gap:8px;
  }
  
  .risk-value{
    font-size:20px;
    font-weight:700;
  }
  
  .risk-level{
    padding:4px 8px;
    border-radius:6px;
    font-size:11px;
    font-weight:600;
  }
  
  .risk-low{
    background:rgba(16,185,129,0.1);
    color:var(--success);
  }
  
  .risk-medium{
    background:rgba(245,158,11,0.1);
    color:var(--warning);
  }
  
  .risk-high{
    background:rgba(239,68,68,0.1);
    color:var(--danger);
  }
  
  .risk-factors{
    display:grid;
    gap:8px;
  }
  
  .risk-factor{
    display:flex;
    justify-content:space-between;
    font-size:12px;
    padding:6px 0;
    border-bottom:1px solid var(--border);
  }
  
  .risk-factor:last-child{
    border-bottom:none;
  }
  
  .factor-label{
    color:var(--text-muted);
  }
  
  .factor-value{
    font-weight:500;
  }
  
  .fee-breakdown{
    background:linear-gradient(135deg, rgba(59,130,246,0.05), rgba(6,182,212,0.05));
    border:1px solid rgba(59,130,246,0.2);
    border-radius:12px;
    padding:16px;
    margin-bottom:20px;
  }
  
  .fee-row{
    display:flex;
    justify-content:space-between;
    padding:8px 0;
    font-size:14px;
  }
  
  .fee-row.total{
    border-top:1px solid rgba(59,130,246,0.2);
    margin-top:8px;
    padding-top:12px;
    font-weight:600;
    font-size:16px;
  }
  
  .fee-label{
    color:var(--text-secondary);
  }
  
  .fee-value{
    color:var(--text-primary);
    font-family:'Courier New', monospace;
  }
  
  .limit-info{
    background:rgba(245,158,11,0.05);
    border:1px solid rgba(245,158,11,0.2);
    border-radius:10px;
    padding:12px;
    margin-bottom:20px;
    display:flex;
    align-items:center;
    gap:12px;
  }
  
  .limit-icon{
    font-size:20px;
  }
  
  .limit-text{
    flex:1;
    font-size:13px;
    color:var(--text-secondary);
  }
  
  .limit-values{
    display:flex;
    gap:16px;
    font-size:12px;
  }
  
  .limit-item{
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  
  .limit-label{
    color:var(--text-muted);
    margin-bottom:4px;
  }
  
  .limit-amount{
    color:var(--warning);
    font-weight:600;
  }
  
  .btn{
    padding:12px 24px;
    border:none;
    border-radius:10px;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  
  .btn:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(0,0,0,0.3);
  }
  
  .btn-primary{
    background:linear-gradient(135deg, var(--primary), var(--primary-dark));
    color:white;
  }
  
  .btn-secondary{
    background:var(--bg-hover);
    color:var(--text-primary);
    border:1px solid var(--border);
  }
  
  .btn-group{
    display:flex;
    gap:12px;
    justify-content:flex-end;
    margin-top:24px;
  }
  
  .security-features{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:28px;
  }
  
  .feature-list{
    display:grid;
    gap:16px;
  }
  
  .feature-item{
    display:flex;
    align-items:flex-start;
    gap:12px;
  }
  
  .feature-icon{
    width:32px;
    height:32px;
    background:rgba(16,185,129,0.1);
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-shrink:0;
  }
  
  .feature-content{
    flex:1;
  }
  
  .feature-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:4px;
  }
  
  .feature-desc{
    font-size:12px;
    color:var(--text-muted);
    line-height:1.5;
  }
  
  .live-transactions{
    margin-top:24px;
  }
  
  .transaction-item{
    display:flex;
    align-items:center;
    padding:12px;
    background:var(--bg-hover);
    border-radius:10px;
    margin-bottom:8px;
    font-size:13px;
  }
  
  .transaction-status{
    width:8px;
    height:8px;
    border-radius:50%;
    margin-right:12px;
    flex-shrink:0;
  }
  
  .status-active{
    background:var(--success);
    animation:pulse 2s infinite;
  }
  
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(16,185,129,0.4)}
    70%{box-shadow:0 0 0 10px rgba(16,185,129,0)}
    100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}
  }
  
  .transaction-info{
    flex:1;
  }
  
  .transaction-id{
    font-family:'Courier New', monospace;
    color:var(--text-muted);
  }
  
  .transaction-amount{
    font-weight:600;
    color:var(--primary);
  }
  
  @media (max-width:968px){
    .main-grid{
      grid-template-columns:1fr;
    }
    .login-form-container{
      flex-direction:column;
      align-items:stretch;
    }
    .login-buttons{
      width:100%;
    }
    .login-btn{
      flex:1;
    }
  }
  
  @media (max-width:640px){
    .form-row{
      grid-template-columns:1fr;
    }
    .role-selector{
      grid-template-columns:1fr;
    }
    .nav-right{
      flex-direction:column;
      gap:12px;
    }
    .login-card-header{
      flex-direction:column;
      text-align:center;
    }
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<div class="container">
  <!-- 顶部导航栏 -->
  <nav class="navbar">
    <div class="logo">
      <div class="logo-icon">🔐</div>
      <span>易趣SafePay</span>
    </div>
    <div class="nav-right">
      <div class="user-info">
        <div class="reputation-score">
          <span>⭐</span>
          <span>信誉分: <span id="userScore">--</span></span>
        </div>
        <span class="kyc-badge">KYC L<span id="kycLevel">-</span></span>
        <span class="user-address-display">用户: <span id="userAddressDisplay">未登录</span></span>
      </div>
    </div>
  </nav>
  
  <!-- 登录卡片 -->
  <div class="login-card">
    <div class="login-card-header">
      <div class="login-card-icon">💼</div>
      <div class="login-card-title">
        <h2>钱包地址登录</h2>
        <p class="login-card-subtitle">输入您的USDT钱包地址以开始使用</p>
      </div>
      <div class="login-status-badge" id="loginStatusBadge">
        ✓ 已登录
      </div>
    </div>
    
    <div class="login-form-container">
      <div class="login-input-wrapper">
        <span class="login-input-icon">💳</span>
        <input type="text" 
               id="walletAddress" 
               class="login-input-field" 
               placeholder="请输入USDT钱包地址 (TRC20: T开头34位 / ERC20/BEP20: 0x开头42位)">
      </div>
      <div class="login-buttons">
        <button class="login-btn primary" id="loginBtn" onclick="handleLogin()">
          <span>🔐</span>
          <span>登入</span>
        </button>
        <button class="login-btn secondary" id="resetBtn" onclick="handleReset()">
          <span>🔄</span>
          <span>重新登入</span>
        </button>
      </div>
    </div>
    
    <div class="login-tips">
      <strong>💡 提示：</strong>
      • 支持 TRC-20 (波场，T开头34位)、ERC-20 (以太坊，0x开头42位)、BEP-20 (币安智能链，0x开头42位) 网络钱包地址<br>
      • 无需私钥或助记词，仅使用公开地址<br>
      • 您的资产始终在您的钱包中，平台仅提供担保服务
    </div>
  </div>
  
  <!-- 主内容区域 -->
  <div class="main-grid">
    <!-- 左侧主要内容 -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">创建智能担保交易</h2>
        <span style="padding:6px 12px;background:rgba(16,185,129,0.1);color:var(--success);border-radius:20px;font-size:12px;font-weight:600;">
          安全模式启用
        </span>
      </div>
      
      <!-- 角色选择 -->
      <div class="role-selector">
        <div class="role-option selected" onclick="selectRole('buyer', this)">
          <div class="role-icon">🛒</div>
          <div class="role-name">我是买方</div>
          <div class="role-desc">购买商品或服务</div>
        </div>
        <div class="role-option" onclick="selectRole('seller', this)">
          <div class="role-icon">💼</div>
          <div class="role-name">我是卖方</div>
          <div class="role-desc">出售商品或服务</div>
        </div>
      </div>
      
      <!-- 交易表单 -->
      <form id="escrowForm">
        <div class="form-group">
          <label>对方钱包地址 <span class="required">*</span></label>
          <input type="text" id="counterpartyAddress" placeholder="输入对方钱包地址 (TRC20: T开头 / ERC20/BEP20: 0x开头)" onblur="checkAddress(this.value)">
          <div id="addressWarning" style="display:none;margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:12px;color:var(--danger);">
            ⚠️ 该地址存在风险记录
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>交易金额 (USDT) <span class="required">*</span></label>
            <input type="number" id="amount" step="0.01" min="10" placeholder="最低 10 USDT" oninput="updateRiskAssessment()">
          </div>
          <div class="form-group">
            <label>选择网络 <span class="required">*</span></label>
            <select id="network" onchange="updateFees()">
              <option value="TRC20">TRC-20 (推荐)</option>
              <option value="ERC20">ERC-20</option>
              <option value="BEP20">BEP-20</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>托管期限 <span class="required">*</span></label>
            <select id="escrowPeriod">
              <option value="24">24小时 - 快速交易</option>
              <option value="72" selected>3天 - 标准交易</option>
              <option value="168">7天 - 大额交易</option>
              <option value="360">15天 - 定制交易</option>
            </select>
          </div>
          <div class="form-group">
            <label>交易类型</label>
            <select id="transactionType" onchange="updateRiskAssessment()">
              <option value="goods">实物商品</option>
              <option value="digital">数字商品</option>
              <option value="service">服务类</option>
              <option value="other">其他</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>交易描述 <span class="required">*</span></label>
          <textarea id="description" placeholder="详细描述交易内容，便于争议处理（至少30字）" minlength="30"></textarea>
        </div>
        
        <!-- 风险评估 -->
        <div class="risk-assessment">
          <div class="risk-header">
            <span class="risk-title">🛡️ 风险评估</span>
            <div class="risk-score">
              <span class="risk-value" id="riskScore">25</span>
              <span class="risk-level risk-low" id="riskLevel">低风险</span>
            </div>
          </div>
          <div class="risk-factors">
            <div class="risk-factor">
              <span class="factor-label">对方信誉</span>
              <span class="factor-value" id="counterpartyRep">待验证</span>
            </div>
            <div class="risk-factor">
              <span class="factor-label">交易金额</span>
              <span class="factor-value" id="amountRisk">正常</span>
            </div>
            <div class="risk-factor">
              <span class="factor-label">交易频率</span>
              <span class="factor-value">正常</span>
            </div>
            <div class="risk-factor">
              <span class="factor-label">地址风险</span>
              <span class="factor-value" id="addressRisk">待检测</span>
            </div>
          </div>
        </div>
        
        <!-- 限额提示 -->
        <div class="limit-info">
          <span class="limit-icon">⚠️</span>
          <div class="limit-text">
            您的当前交易限额（基于KYC等级和信誉分）
          </div>
          <div class="limit-values">
            <div class="limit-item">
              <span class="limit-label">单笔</span>
              <span class="limit-amount">$50,000</span>
            </div>
            <div class="limit-item">
              <span class="limit-label">每日</span>
              <span class="limit-amount">$500,000</span>
            </div>
            <div class="limit-item">
              <span class="limit-label">每月</span>
              <span class="limit-amount">$10,000,000</span>
            </div>
          </div>
        </div>
        
        <!-- 费用明细 -->
        <div class="fee-breakdown">
          <div class="fee-row">
            <span class="fee-label">交易金额</span>
            <span class="fee-value" id="feeAmount">0.00 USDT</span>
          </div>
          <div class="fee-row">
            <span class="fee-label">平台服务费 (0.5%-1%)</span>
            <span class="fee-value" id="feeService">0.00 USDT</span>
          </div>
          <div class="fee-row">
            <span class="fee-label">网络手续费（预估）</span>
            <span class="fee-value" id="feeNetwork">1.00 USDT</span>
          </div>
          <div class="fee-row">
            <span class="fee-label">风险保证金（可退）</span>
            <span class="fee-value" id="feeDeposit">0.00 USDT</span>
          </div>
          <div class="fee-row total">
            <span class="fee-label">需支付总额</span>
            <span class="fee-value" id="feeTotal">0.00 USDT</span>
          </div>
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="saveDraft()">
            💾 保存草稿
          </button>
          <button type="submit" class="btn btn-primary">
            🚀 创建担保交易
          </button>
        </div>
      </form>
    </div>
    
    <!-- 右侧信息 -->
    <div>
      <!-- 安全特性 -->
      <div class="security-features">
        <h3 style="font-size:18px;margin-bottom:20px;">🔒 安全保障</h3>
        <div class="feature-list">
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <div class="feature-content">
              <div class="feature-title">智能合约托管</div>
              <div class="feature-desc">资金锁定在智能合约，任何一方无法单独提取</div>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <div class="feature-content">
              <div class="feature-title">链上验证</div>
              <div class="feature-desc">所有交易都经过区块链验证，确保真实性</div>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <div class="feature-content">
              <div class="feature-title">争议仲裁</div>
              <div class="feature-desc">专业团队介入，基于证据链公正裁决</div>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <div class="feature-content">
              <div class="feature-title">时效保护</div>
              <div class="feature-desc">超时自动处理，避免资金长期冻结</div>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">✓</div>
            <div class="feature-content">
              <div class="feature-title">信誉系统</div>
              <div class="feature-desc">基于历史交易的动态信誉评分机制</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 实时交易 -->
      <div class="card live-transactions">
        <h3 style="font-size:16px;margin-bottom:16px;">📊 实时交易动态</h3>
        <div id="liveTransactions">
          <div class="transaction-item">
            <span class="transaction-status status-active"></span>
            <div class="transaction-info">
              <div class="transaction-id">TX#7F9A...3D2E</div>
              <div><span class="transaction-amount">500 USDT</span> • 刚刚</div>
            </div>
          </div>
          <div class="transaction-item">
            <span class="transaction-status status-active"></span>
            <div class="transaction-info">
              <div class="transaction-id">TX#8B3C...9A1F</div>
              <div><span class="transaction-amount">1,200 USDT</span> • 2分钟前</div>
            </div>
          </div>
          <div class="transaction-item">
            <span class="transaction-status status-active"></span>
            <div class="transaction-info">
              <div class="transaction-id">TX#5D2E...7C4B</div>
              <div><span class="transaction-amount">89 USDT</span> • 5分钟前</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// 全局变量
let currentRole = 'buyer';
let riskScore = 25;
let currentUserAddress = '';
let isLoggedIn = false;

// 示例钱包地址（用于测试）
const exampleAddresses = {
  TRC20: 'TN8Rf5PbEXe4XZDGt5H7dQBWoAMphDpg8K',
  ERC20: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb4',
  BEP20: '0x8617E340b3D01FA5f11f306f4090FD50E238070D'
};

// 页面加载时初始化
window.addEventListener('DOMContentLoaded', function() {
  // 初始化
  document.getElementById('walletAddress').value = '';
  
  // 监听回车键
  document.getElementById('walletAddress').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !isLoggedIn) {
      handleLogin();
    }
  });
  
  // 初始化表单提交
  document.getElementById('escrowForm').addEventListener('submit', handleFormSubmit);
  
  // 初始化其他功能
  updateFees();
  startLiveUpdates();
});

// 验证钱包地址格式
function isValidWalletAddress(address) {
  // TRC-20 地址：以T开头，长度34位，包含字母数字
  const trc20Pattern = /^T[A-Za-z0-9]{33}$/;
  
  // ERC-20/BEP-20 地址：以0x开头，长度42位，包含十六进制字符
  const erc20Pattern = /^0x[a-fA-F0-9]{40}$/;
  
  return trc20Pattern.test(address) || erc20Pattern.test(address);
}

// 检测地址类型
function detectAddressType(address) {
  if (address.startsWith('T') && address.length === 34) {
    return 'TRC-20';
  } else if (address.startsWith('0x') && address.length === 42) {
    return 'ERC-20/BEP-20';
  }
  return 'Unknown';
}

// 登入功能 - 固定信誉分为80，KYC为L1
function handleLogin() {
  const addressInput = document.getElementById('walletAddress');
  const address = addressInput.value.trim();
  
  if (!address) {
    alert('请输入钱包地址');
    return;
  }
  
  // ★★★ 验证钱包地址格式 ★★★
  if (!isValidWalletAddress(address)) {
    const exampleAddresses = 
      '支持的钱包地址格式：\n\n' +
      '• TRC-20 (波场): 以T开头，34位\n' +
      '  示例: TN8Rf5PbEXe4XZDGt5H7dQBWoAMphDpg8K\n\n' +
      '• ERC-20 (以太坊): 以0x开头，42位\n' +
      '  示例: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb4\n\n' +
      '• BEP-20 (币安链): 以0x开头，42位\n' +
      '  示例: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb4\n\n' +
      '请检查您的钱包地址格式是否正确！';
    alert(exampleAddresses);
    return;
  }
  
  // 检测地址类型
  const addressType = detectAddressType(address);
  console.log('钱包地址类型:', addressType);
  
  // 保存地址并设置登录状态
  currentUserAddress = address;
  isLoggedIn = true;
  
  // 锁定输入框
  addressInput.disabled = true;
  
  // 显示登录状态
  document.getElementById('loginStatusBadge').classList.add('show');
  
  // 更新用户地址显示
  const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
  document.getElementById('userAddressDisplay').textContent = shortAddress;
  document.getElementById('userAddressDisplay').title = address;
  
  // ★★★ 核心：设置固定的信誉分80和KYC L1 ★★★
  document.getElementById('userScore').textContent = '80';
  document.getElementById('kycLevel').textContent = '1';
  
  // 显示成功提示（包含地址类型）
  setTimeout(() => {
    alert(`登录成功！\n\n钱包地址类型：${addressType}\n钱包地址：${shortAddress}\n\n欢迎使用易趣SafePay担保交易平台`);
  }, 300);
}

// 重新登入功能
function handleReset() {
  // 重置登录状态
  isLoggedIn = false;
  currentUserAddress = '';
  
  // 解锁并清空输入框
  const addressInput = document.getElementById('walletAddress');
  addressInput.value = '';
  addressInput.disabled = false;
  
  // 隐藏登录状态
  document.getElementById('loginStatusBadge').classList.remove('show');
  
  // 重置显示
  document.getElementById('userAddressDisplay').textContent = '未登录';
  document.getElementById('userAddressDisplay').title = '';
  document.getElementById('userScore').textContent = '--';
  document.getElementById('kycLevel').textContent = '-';
  
  // 聚焦输入框
  addressInput.focus();
}

// 角色选择
function selectRole(role, element) {
  currentRole = role;
  document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
  element.classList.add('selected');
  updateRiskAssessment();
}

// 地址检查
function checkAddress(address) {
  if (!address || address.length < 20) return;
  
  // ★★★ 先验证地址格式 ★★★
  if (!isValidWalletAddress(address)) {
    document.getElementById('addressWarning').innerHTML = 
      '⚠️ 无效的钱包地址格式！请输入正确的TRC-20、ERC-20或BEP-20地址';
    document.getElementById('addressWarning').style.display = 'block';
    document.getElementById('addressRisk').textContent = '格式错误';
    document.getElementById('addressRisk').style.color = 'var(--danger)';
    return;
  }
  
  setTimeout(() => {
    const riskyAddresses = ['TRX123', 'TRY456'];
    const isRisky = riskyAddresses.some(risky => address.includes(risky));
    
    if (isRisky) {
      document.getElementById('addressWarning').innerHTML = 
        '⚠️ 该地址存在风险记录';
      document.getElementById('addressWarning').style.display = 'block';
      document.getElementById('addressRisk').textContent = '⚠️ 高风险';
      document.getElementById('addressRisk').style.color = 'var(--danger)';
    } else {
      document.getElementById('addressWarning').style.display = 'none';
      document.getElementById('addressRisk').textContent = '✓ 安全';
      document.getElementById('addressRisk').style.color = 'var(--success)';
    }
    
    // 对方信誉也固定为80分
    document.getElementById('counterpartyRep').textContent = '80 分';
    
    updateRiskAssessment();
  }, 1000);
}

// 更新风险评估
function updateRiskAssessment() {
  const amount = parseFloat(document.getElementById('amount').value) || 0;
  const transactionType = document.getElementById('transactionType').value;
  
  let score = 25;
  
  if (amount > 10000) {
    score += 30;
    document.getElementById('amountRisk').textContent = '⚠️ 大额';
  } else if (amount > 5000) {
    score += 15;
    document.getElementById('amountRisk').textContent = '中等';
  } else {
    document.getElementById('amountRisk').textContent = '正常';
  }
  
  if (transactionType === 'digital') {
    score += 10;
  }
  
  riskScore = Math.min(100, score);
  document.getElementById('riskScore').textContent = riskScore;
  
  const riskLevel = document.getElementById('riskLevel');
  if (riskScore < 40) {
    riskLevel.textContent = '低风险';
    riskLevel.className = 'risk-level risk-low';
  } else if (riskScore < 70) {
    riskLevel.textContent = '中风险';
    riskLevel.className = 'risk-level risk-medium';
  } else {
    riskLevel.textContent = '高风险';
    riskLevel.className = 'risk-level risk-high';
  }
  
  updateFees();
}

// ★★★ 修复：更新费用函数 ★★★
function updateFees() {
  const amount = parseFloat(document.getElementById('amount').value) || 0;
  const network = document.getElementById('network').value;
  
  // 计算服务费（根据风险评分）
  let serviceFeeRate = riskScore < 40 ? 0.005 : riskScore < 70 ? 0.007 : 0.01;
  const serviceFee = amount * serviceFeeRate;
  
  // 计算网络费
  const networkFees = {
    'TRC20': 1,
    'ERC20': 5,
    'BEP20': 0.5
  };
  const networkFee = networkFees[network] || 1;
  
  // 计算保证金（低/中风险固定5 USDT，高风险按比例）
  const deposit = amount === 0 ? 0 : (riskScore > 70 ? amount * 0.05 : 5);
  
  // 计算总额
  const totalAmount = amount + serviceFee + networkFee + deposit;
  
  // 更新页面显示
  document.getElementById('feeAmount').textContent = amount.toFixed(2) + ' USDT';
  document.getElementById('feeService').textContent = serviceFee.toFixed(2) + ' USDT';
  document.getElementById('feeNetwork').textContent = networkFee.toFixed(2) + ' USDT';
  document.getElementById('feeDeposit').textContent = deposit.toFixed(2) + ' USDT';
  document.getElementById('feeTotal').textContent = totalAmount.toFixed(2) + ' USDT';
}

// 保存草稿
function saveDraft() {
  if (!isLoggedIn) {
    alert('请先登录钱包地址');
    document.getElementById('walletAddress').focus();
    return;
  }
  
  const formData = {
    role: currentRole,
    counterpartyAddress: document.getElementById('counterpartyAddress').value,
    amount: document.getElementById('amount').value,
    network: document.getElementById('network').value,
    escrowPeriod: document.getElementById('escrowPeriod').value,
    transactionType: document.getElementById('transactionType').value,
    description: document.getElementById('description').value,
    userAddress: currentUserAddress
  };
  
  localStorage.setItem('escrowDraft', JSON.stringify(formData));
  alert('草稿已保存');
}

// ★★★ 核心修复：提交表单函数 ★★★
function handleFormSubmit(e) {
  e.preventDefault();
  
  if (!isLoggedIn) {
    alert('请先登录钱包地址');
    document.getElementById('walletAddress').focus();
    return;
  }
  
  // ★★★ 验证对方钱包地址格式 ★★★
  const counterpartyAddress = document.getElementById('counterpartyAddress').value.trim();
  if (!counterpartyAddress) {
    alert('请输入对方钱包地址');
    document.getElementById('counterpartyAddress').focus();
    return;
  }
  
  if (!isValidWalletAddress(counterpartyAddress)) {
    alert('对方钱包地址格式无效！\n\n请确保地址格式正确：\n• TRC-20: T开头，34位\n• ERC-20/BEP-20: 0x开头，42位');
    document.getElementById('counterpartyAddress').focus();
    return;
  }
  
  const amount = parseFloat(document.getElementById('amount').value);
  
  // 只检查最小金额
  if (!amount || amount < 10) {
    alert('最小交易金额为 10 USDT');
    document.getElementById('amount').focus();
    return;
  }
  
  // 验证描述
  const description = document.getElementById('description').value.trim();
  if (description.length < 30) {
    alert('交易描述至少需要30个字符，请详细描述交易内容');
    document.getElementById('description').focus();
    return;
  }
  
  // 高风险警告
  if (riskScore > 70) {
    if (!confirm(`⚠️ 风险提示\n\n当前交易风险评分：${riskScore}\n建议谨慎交易。是否继续？`)) {
      return;
    }
  }
  
  // ★★★ 计算所有费用 ★★★
  const network = document.getElementById('network').value;
  
  // 计算服务费（根据风险评分）
  let serviceFeeRate = riskScore < 40 ? 0.005 : riskScore < 70 ? 0.007 : 0.01;
  const serviceFee = amount * serviceFeeRate;
  
  // 计算网络费
  const networkFees = {
    'TRC20': 1,
    'ERC20': 5,
    'BEP20': 0.5
  };
  const networkFee = networkFees[network] || 1;
  
  // 计算保证金（低/中风险固定5 USDT，高风险按比例）
  const deposit = riskScore > 70 ? amount * 0.05 : 5;
  
  // 计算总额
  const totalAmount = amount + serviceFee + networkFee + deposit;
  
  console.log('费用计算:', {
    amount: amount,
    serviceFee: serviceFee,
    networkFee: networkFee,
    deposit: deposit,
    totalAmount: totalAmount,
    riskScore: riskScore
  });
  
  // 生成交易ID
  const txId = 'ESC' + Date.now().toString(36).toUpperCase();
  
  // ★★★ 创建包含所有费用信息的交易对象 ★★★
  const transaction = {
    id: txId,
    role: currentRole,
    userAddress: currentUserAddress,
    userScore: 80,  // 用户信誉分
    counterpartyAddress: counterpartyAddress,  // 使用验证过的地址
    counterpartyScore: 80,  // 对方信誉分
    amount: amount,
    serviceFee: serviceFee,      // ✅ 服务费
    networkFee: networkFee,      // ✅ 网络费
    deposit: deposit,            // ✅ 保证金
    totalAmount: totalAmount,    // ✅ 总额
    network: network,
    escrowPeriod: document.getElementById('escrowPeriod').value,
    transactionType: document.getElementById('transactionType').value,
    description: description,  // 使用验证过的描述
    riskScore: riskScore,
    status: 'CREATED',
    createdAt: new Date().toISOString()
  };
  
  console.log('保存的交易数据:', transaction);
  
  // 保存到sessionStorage用于页面间传递数据
  sessionStorage.setItem('currentTransaction', JSON.stringify(transaction));
  
  // 同时保存到localStorage以便持久化
  localStorage.setItem('latestTransaction', JSON.stringify(transaction));
  
  // 显示成功提示（包含费用明细）
  alert(`交易创建成功！\n\n交易ID: ${txId}\n交易金额: ${amount.toFixed(2)} USDT\n服务费: ${serviceFee.toFixed(2)} USDT\n网络费: ${networkFee.toFixed(2)} USDT\n保证金: ${deposit.toFixed(2)} USDT\n总计: ${totalAmount.toFixed(2)} USDT\n\n即将跳转到支付页面...`);
  
  // 跳转到第二个页面
  setTimeout(() => {
    window.location.href = './dbjy1.html';
  }, 500); // 延迟500毫秒让用户看到提示
}

// 实时交易更新
function startLiveUpdates() {
  setInterval(() => {
    const amounts = [50, 100, 200, 500, 1000, 2500, 5000];
    const amount = amounts[Math.floor(Math.random() * amounts.length)];
    const txId = Math.random().toString(36).substr(2, 4).toUpperCase();
    
    const newTransaction = `
      <div class="transaction-item" style="animation: fadeIn 0.5s">
        <span class="transaction-status status-active"></span>
        <div class="transaction-info">
          <div class="transaction-id">TX#${txId}...${Math.random().toString(36).substr(2, 4).toUpperCase()}</div>
          <div><span class="transaction-amount">${amount} USDT</span> • 刚刚</div>
        </div>
      </div>
    `;
    
    const container = document.getElementById('liveTransactions');
    if (container) {
      container.insertAdjacentHTML('afterbegin', newTransaction);
      
      while (container.children.length > 5) {
        container.removeChild(container.lastChild);
      }
    }
  }, 8000);
}
</script>

</body>
</html>
